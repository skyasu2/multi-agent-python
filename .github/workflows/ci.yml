name: PlanCraft CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    # =========================================================================
    # 버전 호환성 체크 (Version Compatibility Check)
    # =========================================================================
    - name: Check dependency versions
      run: |
        echo "=== Python Version ==="
        python --version
        echo ""

        echo "=== Core Dependencies ==="
        pip show langchain langchain-core langchain-openai langgraph pydantic streamlit | grep -E "^(Name|Version):"
        echo ""

        echo "=== Version Compatibility Matrix ==="
        python -c "
        import sys
        from importlib.metadata import version

        # 권장 버전 범위 정의
        RECOMMENDED_VERSIONS = {
            'langchain': ('0.3.0', '0.4.0'),
            'langchain-core': ('0.3.0', '0.4.0'),
            'langgraph': ('0.2.0', '0.3.0'),
            'pydantic': ('2.0.0', '3.0.0'),
            'streamlit': ('1.30.0', '2.0.0'),
        }

        def parse_version(v):
            return tuple(map(int, v.split('.')[:3]))

        warnings = []
        for pkg, (min_ver, max_ver) in RECOMMENDED_VERSIONS.items():
            try:
                installed = version(pkg)
                installed_tuple = parse_version(installed)
                min_tuple = parse_version(min_ver)
                max_tuple = parse_version(max_ver)

                status = '✅'
                if installed_tuple < min_tuple:
                    status = '⚠️ TOO OLD'
                    warnings.append(f'{pkg}: {installed} < {min_ver}')
                elif installed_tuple >= max_tuple:
                    status = '⚠️ NEWER THAN TESTED'
                    warnings.append(f'{pkg}: {installed} >= {max_ver}')

                print(f'{pkg}: {installed} (recommended: {min_ver} ~ {max_ver}) {status}')
            except Exception as e:
                print(f'{pkg}: NOT INSTALLED')

        print()
        if warnings:
            print('=== WARNINGS ===')
            for w in warnings:
                print(f'  - {w}')
            print()
            print('Version mismatch detected. Tests may fail or behave unexpectedly.')
        else:
            print('All versions are within recommended range.')
        "

    - name: Check for outdated packages
      run: |
        echo "=== Outdated Packages (Info Only) ==="
        pip list --outdated --format=columns | head -20 || true

    # =========================================================================
    # 코드 문법 검사 (Syntax Check)
    # =========================================================================
    - name: Syntax Check
      run: |
        python -m py_compile graph/workflow.py
        python -m py_compile graph/interrupt_types.py
        python -m py_compile graph/interrupt_utils.py
        python -m py_compile utils/time_travel.py
        echo "✅ Syntax check passed"

    # =========================================================================
    # 단위 테스트 (Unit Tests)
    # =========================================================================
    - name: Run Unit Tests (Interrupt Types)
      env:
        PYTHONPATH: ${{ github.workspace }}
      run: |
        pytest tests/test_interrupt_types.py -v --tb=short

    - name: Run Unit Tests (Interrupt & Schema)
      env:
        PYTHONPATH: ${{ github.workspace }}
      run: |
        pytest tests/test_interrupt_unit.py tests/test_ui_integration.py -v --tb=short

    - name: Run Time Travel Tests
      env:
        PYTHONPATH: ${{ github.workspace }}
      run: |
        pytest tests/test_time_travel.py -v --tb=short -k "Mock or Errors or StateSnapshot"

    # =========================================================================
    # 시나리오 테스트 (Scenario Tests)
    # =========================================================================
    - name: Run Scenario Tests
      env:
        PYTHONPATH: ${{ github.workspace }}
        LANGCHAIN_TRACING_V2: ${{ secrets.LANGCHAIN_TRACING_V2 || 'false' }}
        LANGCHAIN_API_KEY: ${{ secrets.LANGCHAIN_API_KEY }}
        LANGCHAIN_PROJECT: "PlanCraft-CI"
      run: |
        pytest tests/test_scenarios.py -v

    - name: Run Routing Tests
      env:
        PYTHONPATH: ${{ github.workspace }}
      run: |
        pytest tests/test_workflow_routing.py -v --tb=short || true

  # ===========================================================================
  # 버전 호환성 매트릭스 테스트 (선택적)
  # ===========================================================================
  version-matrix:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12"]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run core tests
      env:
        PYTHONPATH: ${{ github.workspace }}
      run: |
        pytest tests/test_interrupt_types.py tests/test_time_travel.py -v --tb=short -k "Mock or Errors or StateSnapshot" || true
