============================= test session starts =============================
platform win32 -- Python 3.13.5, pytest-9.0.2, pluggy-1.6.0 -- C:\Python313\python.exe
cachedir: .pytest_cache
rootdir: D:\개인\ai ax\pro
plugins: anyio-4.9.0, langsmith-0.5.1
collecting ... collected 2 items

tests/test_hitl_simulation.py::test_hitl_interrupt_and_resume FAILED     [ 50%]
tests/test_hitl_simulation.py::test_time_travel_forking FAILED           [100%]

================================== FAILURES ===================================
_______________________ test_hitl_interrupt_and_resume ________________________

test_app = <langgraph.graph.state.CompiledStateGraph object at 0x0000016B7A547110>
mock_llm_chain = <MagicMock name='_get_analyzer_llm()' id='1561127063232'>

    def test_hitl_interrupt_and_resume(test_app, mock_llm_chain):
        """
        [E2E] 인터럽트 발생 및 재개 테스트
    
        Flow:
        1. Analyzer 실행 -> need_more_info=True -> 'option_pause' 노드 도달
        2. Interrupt 발생 확인 (실행 멈춤)
        3. Resume (옵션A 선택) -> 실행 재개 -> 'analyze' 재실행 -> 'structure' 진행
        """
        thread_id = "test_hitl_thread_1"
        config = {"configurable": {"thread_id": thread_id}}
    
        # 1. 초기 실행
        inputs = {
            "user_input": "기획해줘",
            "thread_id": thread_id
        }
    
        # 첫 번째 실행 (여기서 멈춰야 함)
        # until="option_pause" 옵션이나 stream을 써도 되지만, interrupt가 발생하면 자동 멈춤.
        print("\n[Test] 1. 실행 시작...")
    
        # analyze -> should_ask_user(option_pause) -> option_pause_node(interrupt)
        # interrupt가 발생하면 앱 실행이 종료되고 마지막 상태가 저장됨.
        try:
            # stream 대신 invoke 사용 시 interrupt에서 멈추고 결과를 반환하지 않거나
            # 마지막 스냅샷 상태로 종료됨. (LangGraph 버전에 따라 상이하나 최신은 멈춤)
            # 확인을 위해 list(app.stream(...))을 사용
            events = list(test_app.stream(inputs, config=config))
        except Exception as e:
            print(f"Execution stopped as expected? {e}")
    
        # 2. 상태 확인 (멈췄는지)
        snapshot = test_app.get_state(config)
        print(f"\n[Test] 2. 스냅샷 확인: Next={snapshot.next}")
    
        # 다음 실행할 노드가 있는지, 그리고 tasks에 interrupt가 있는지 확인
        assert snapshot.next, "실행이 완전히 끝나지 않았어야 함 (Next step 존재)"
    
        # [Check] 현재 option_pause 상태인지 확인
        # 구조상: option_pause_node는 실행되다가 interrupt()에서 멈춤.
        # 따라서 next는 없거나, tasks 속 내부에 interrupt 정보가 있어야 함.
        # LangGraph 최신 스펙: tasks[0].interrupts에 정보가 있음.
    
        task = snapshot.tasks[0]
        assert len(task.interrupts) > 0, "인터럽트가 발생해야 함"
        interrupt_value = task.interrupts[0].value
    
        print(f"[Test] 인터럽트 페이로드: {interrupt_value}")
        # [UPDATE] InterruptType Enum 표준화로 'option'으로 변경됨
        assert interrupt_value["type"] == "option"
        assert interrupt_value["question"] == "어디로 갈까요?"
        # [NEW] Semantic Key 검증
        assert interrupt_value.get("interrupt_id") == "analyze_direction_select"
    
        # 3. Resume (재개)
        print("\n[Test] 3. Resume (옵션 선택)...")
        from langgraph.types import Command
    
        resume_payload = {
            "selected_option": {"title": "옵션A", "description": "설명A"}
        }
    
        # Command(resume=...)를 사용하여 재개
        # option_pause_node는 resume 값을 받아서 update_state 후 'analyze'로 이동하도록 되어있음
    
        # Mock LLM의 응답을 바꿔줘야 함 (안그러면 또 물어봄)
        # Analyzer가 두 번째 호출될 때는 need_more_info=False여야 무한루프 안돔.
        # side_effect를 사용하여 첫 호출, 두 번째 호출 다르게 설정
    
        mock_llm_chain.invoke.side_effect = [
            # 첫 번째 호출 (위에서 이미 소비됨)
>           AnalysisResult(need_more_info=True, options=[], option_question=""),
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
            # 두 번째 호출 (Resume 후) -> 이제 정보 충분
            AnalysisResult(
                topic="옵션A 기반 기획",
                need_more_info=False, # 진행!
                is_general_query=False
            )
        ]
E       pydantic_core._pydantic_core.ValidationError: 3 validation errors for AnalysisResult
E       topic
E         Field required [type=missing, input_value={'need_more_info': True, ..., 'option_question': ''}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       purpose
E         Field required [type=missing, input_value={'need_more_info': True, ..., 'option_question': ''}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       target_users
E         Field required [type=missing, input_value={'need_more_info': True, ..., 'option_question': ''}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests\test_hitl_simulation.py:130: ValidationError
---------------------------- Captured stdout call -----------------------------
\n[Test] 1. \uc2e4\ud589 \uc2dc\uc791...\n[Subgraph] \ubcd1\ub82c Context Gathering Started\n[WARN] Failed to load vectorstore: Error in __cdecl faiss::FileIOReader::FileIOReader(const char *) at D:\\a\\faiss-wheels\\faiss-wheels\\third-party\\faiss\\faiss\\impl\\io.cpp:70: Error: 'f' failed: could not open D:\\\uac1c\uc778\\ai ax\\pro\\rag\\faiss_index\\index.faiss for reading: No such file or directory\n  -> Reinitializing...\n[INFO] Loading documents from: D:\\\uac1c\uc778\\ai ax\\pro\\rag\\documents\n  - Documents loaded: 5\n  - Chunking documents...\n    > Header-based splits: 105\n    > Final chunks created: 105\n  - Creating embeddings...\n[WARN] LLM \ucffc\ub9ac \uc0dd\uc131 \uc2e4\ud328: Error code: 403 - {'error': {'code': '403', 'message': 'A Virtual Network is configured for this resource. Please use the correct endpoint for making requests. Check https://aka.ms/cogsvc-vnet for more details.'}}, Regex Fallback \uc0ac\uc6a9\n\u26a0\ufe0f langchain-mcp-adapters \ud328\ud0a4\uc9c0\uac00 \uc124\uce58\ub418\uc9c0 \uc54a\uc558\uc2b5\ub2c8\ub2e4\n\u26a0\ufe0f langchain-mcp-adapters \ud328\ud0a4\uc9c0\uac00 \uc124\uce58\ub418\uc9c0 \uc54a\uc558\uc2b5\ub2c8\ub2e4\n[WARN] \uac80\uc0c9 \uc2e4\ud328 (\uae30\ud68d\ud574\uc918 2026 \ud2b8\ub80c\ub4dc): tavily-python not installed. Run: pip install tavily-python\n[WARN] \uac80\uc0c9 \uc2e4\ud328 (\uae30\ud68d\ud574\uc918 2026 \uc2dc\uc7a5 \uaddc\ubaa8 \ud1b5\uacc4): tavily-python not installed. Run: pip install tavily-python\n[Subgraph] Context Gathering \uc644\ub8cc (2.50\ucd08)\n[HITL] Option Interrupt Payload Created (ID: analyze_direction_select)\n\n[Test] 2. \uc2a4\ub0c5\uc0f7 \ud655\uc778: Next=('option_pause',)\n[Test] \uc778\ud130\ub7fd\ud2b8 \ud398\uc774\ub85c\ub4dc: {'type': 'option', 'question': '\uc5b4\ub514\ub85c \uac08\uae4c\uc694?', 'data': {'user_input': '\uae30\ud68d\ud574\uc918', 'need_more_info': True, 'retry_count': 0}, 'node_ref': 'option_pause_node', 'event_id': 'evt_9c41e0d0ad94', 'timestamp': '2026-01-01T12:35:50', 'interrupt_id': 'analyze_direction_select', 'expires_at': '2026-01-01T13:35:50.484718', 'options': [{'title': '\uc635\uc158A', 'description': '\uc124\uba85A', 'value': None}, {'title': '\uc635\uc158B', 'description': '\uc124\uba85B', 'value': None}], 'allow_multiple': False, 'allow_custom': True}\n\n[Test] 3. Resume (\uc635\uc158 \uc120\ud0dd)...
__________________________ test_time_travel_forking ___________________________

test_app = <langgraph.graph.state.CompiledStateGraph object at 0x0000016B7F647610>
mock_llm_chain = <MagicMock name='_get_analyzer_llm()' id='1561211254640'>

    def test_time_travel_forking(test_app, mock_llm_chain):
        """
        [E2E] Time Travel (Forking) 테스트
    
        Flow:
        1. 인터럽트 지점까지 실행
        2. 옵션A로 진행
        3. 다시 인터럽트 지점으로 '되감기' (Time Travel)
        4. 옵션B로 진행 (Fork) -> 다른 결과 확인
        """
        thread_id = "test_fork_thread_1"
        config = {"configurable": {"thread_id": thread_id}}
        inputs = {"user_input": "기획해줘", "thread_id": thread_id}
    
        # 1. 인터럽트 지점 도달
        try:
            list(test_app.stream(inputs, config=config))
        except: pass
    
        # 현재 체크포인트 ID 저장 (분기점)
        snapshot = test_app.get_state(config)
        fork_checkpoint_id = snapshot.config["configurable"]["checkpoint_id"]
        print(f"\n[Test] 분기점 Checkpoint ID: {fork_checkpoint_id}")
    
        # 2. 경로 A 진행
>       mock_llm_chain.invoke.side_effect = [AnalysisResult(topic="Plan A", need_more_info=False)]
                                             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       pydantic_core._pydantic_core.ValidationError: 2 validation errors for AnalysisResult
E       purpose
E         Field required [type=missing, input_value={'topic': 'Plan A', 'need_more_info': False}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       target_users
E         Field required [type=missing, input_value={'topic': 'Plan A', 'need_more_info': False}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

tests\test_hitl_simulation.py:195: ValidationError
---------------------------- Captured stdout call -----------------------------
[Subgraph] \ubcd1\ub82c Context Gathering Started\n[WARN] Failed to load vectorstore: Error in __cdecl faiss::FileIOReader::FileIOReader(const char *) at D:\\a\\faiss-wheels\\faiss-wheels\\third-party\\faiss\\faiss\\impl\\io.cpp:70: Error: 'f' failed: could not open D:\\\uac1c\uc778\\ai ax\\pro\\rag\\faiss_index\\index.faiss for reading: No such file or directory\n  -> Reinitializing...\n[INFO] Loading documents from: D:\\\uac1c\uc778\\ai ax\\pro\\rag\\documents\n  - Documents loaded: 5\n  - Chunking documents...\n    > Header-based splits: 105\n    > Final chunks created: 105\n  - Creating embeddings...\n[WARN] LLM \ucffc\ub9ac \uc0dd\uc131 \uc2e4\ud328: Error code: 403 - {'error': {'code': '403', 'message': 'A Virtual Network is configured for this resource. Please use the correct endpoint for making requests. Check https://aka.ms/cogsvc-vnet for more details.'}}, Regex Fallback \uc0ac\uc6a9\n\u26a0\ufe0f langchain-mcp-adapters \ud328\ud0a4\uc9c0\uac00 \uc124\uce58\ub418\uc9c0 \uc54a\uc558\uc2b5\ub2c8\ub2e4\n\u26a0\ufe0f langchain-mcp-adapters \ud328\ud0a4\uc9c0\uac00 \uc124\uce58\ub418\uc9c0 \uc54a\uc558\uc2b5\ub2c8\ub2e4\n[WARN] \uac80\uc0c9 \uc2e4\ud328 (\uae30\ud68d\ud574\uc918 2026 \ud2b8\ub80c\ub4dc): tavily-python not installed. Run: pip install tavily-python\n[WARN] \uac80\uc0c9 \uc2e4\ud328 (\uae30\ud68d\ud574\uc918 2026 \uc2dc\uc7a5 \uaddc\ubaa8 \ud1b5\uacc4): tavily-python not installed. Run: pip install tavily-python\n[Subgraph] Context Gathering \uc644\ub8cc (2.45\ucd08)\n[HITL] Option Interrupt Payload Created (ID: analyze_direction_select)\n\n[Test] \ubd84\uae30\uc810 Checkpoint ID: 1f0e6c2f-9892-6ba9-8002-80fd80f765bc
============================== warnings summary ===============================
utils\schemas.py:26
utils\schemas.py:26
  D:\개인\ai ax\pro\utils\schemas.py:26: DeprecationWarning: Importing FieldValidationInfo from `pydantic` is deprecated. This feature is either no longer supported, or is not public.
    from pydantic import BaseModel, Field, field_validator, model_validator, ValidationInfo, FieldValidationInfo

C:\Users\skyasu-pc\AppData\Roaming\Python\Python313\site-packages\pydantic_core\core_schema.py:4324
C:\Users\skyasu-pc\AppData\Roaming\Python\Python313\site-packages\pydantic_core\core_schema.py:4324
  C:\Users\skyasu-pc\AppData\Roaming\Python\Python313\site-packages\pydantic_core\core_schema.py:4324: DeprecationWarning: `FieldValidationInfo` is deprecated, use `ValidationInfo` instead.
    warnings.warn(msg, DeprecationWarning, stacklevel=1)

tests/test_hitl_simulation.py::test_hitl_interrupt_and_resume
  <frozen importlib._bootstrap>:488: DeprecationWarning: builtin type SwigPyPacked has no __module__ attribute

tests/test_hitl_simulation.py::test_hitl_interrupt_and_resume
  <frozen importlib._bootstrap>:488: DeprecationWarning: builtin type SwigPyObject has no __module__ attribute

tests/test_hitl_simulation.py::test_hitl_interrupt_and_resume
  <frozen importlib._bootstrap>:488: DeprecationWarning: builtin type swigvarlink has no __module__ attribute

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/test_hitl_simulation.py::test_hitl_interrupt_and_resume - pydant...
FAILED tests/test_hitl_simulation.py::test_time_travel_forking - pydantic_cor...
======================== 2 failed, 7 warnings in 7.20s ========================
